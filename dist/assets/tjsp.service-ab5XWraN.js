var T=Object.defineProperty;var A=(d,o,a)=>o in d?T(d,o,{enumerable:!0,configurable:!0,writable:!0,value:a}):d[o]=a;var h=(d,o,a)=>A(d,typeof o!="symbol"?o+"":o,a);import{R as p,l as f}from"./realTribunalClient.service-CebukglM.js";import"./index-D82AO8B3.js";class C{constructor(){h(this,"client");this.client=new p({baseURL:"https://esaj.tjsp.jus.br",timeout:3e4,rateLimitDelay:2e3,retryAttempts:3,userAgent:"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"})}async consultarProcesso(o){try{const a=await this.client.makeRequest({method:"GET",url:"/cpopg/open.do"}),t=f(a.data),e=t('input[name="conversationId"]').val()||"",s=t('input[name="_csrf"]').val()||"",r=o.replace(/\D/g,""),n=p.formatarNumeroProcesso(r),i=new URLSearchParams({conversationId:e,"dadosConsulta.valorConsultaNuUnificado":n,"dadosConsulta.valorConsulta":"","dadosConsulta.tipoNuProcesso":"UNIFICADO","dadosConsulta.segredoJustica":"false",uuidCaptcha:"",_csrf:s}),c=await this.client.makeRequest({method:"POST",url:"/cpopg/search.do",data:i,headers:{"Content-Type":"application/x-www-form-urlencoded",Referer:"https://esaj.tjsp.jus.br/cpopg/open.do"}});return this.parseProcessData(c.data,n)}catch(a){throw new Error(`Erro na consulta TJSP: ${a instanceof Error?a.message:"Erro desconhecido"}`)}}parseProcessData(o,a){const t=f(o);if(t(".mensagemExibindo").text().includes("não foi possível localizar"))throw new Error("Processo não encontrado no TJSP");const e={numero:a,classe:"",assunto:"",dataAjuizamento:"",situacao:"Em andamento",localizacao:"",orgaoJulgador:"",partes:[],advogados:[],movimentacoes:[],audiencias:[],documentos:[],recursos:[]};e.classe=this.extractFieldValue(t,"Classe")||"Não informado",e.assunto=this.extractFieldValue(t,"Assunto")||"Não informado",e.orgaoJulgador=this.extractFieldValue(t,"Órgão julgador")||this.extractFieldValue(t,"Vara")||"Não informado";const s=this.extractFieldValue(t,"Distribuição");if(s){const n=s.match(/(\d{2}\/\d{2}\/\d{4})/);if(n){const[i,c,l]=n[1].split("/");e.dataAjuizamento=`${l}-${c}-${i}`}}const r=this.extractFieldValue(t,"Valor da ação");if(r){const n=r.replace(/[^\d,]/g,"").replace(",",".");e.valorCausa=parseFloat(n)||0}return e.partes=this.extractPartes(t),e.advogados=this.extractAdvogados(t),e.movimentacoes=this.extractMovimentacoes(t),e.localizacao=this.extractFieldValue(t,"Localização")||e.orgaoJulgador||"Não informado",e}extractFieldValue(o,a){let t="";return o(`.label:contains("${a}")`,".unj-entity-header").next(".value").each((e,s)=>{t=o(s).text().trim()}),o(`td:contains("${a}")`).next("td").each((e,s)=>{t||(t=o(s).text().trim())}),o(`span:contains("${a}")`).next("span").each((e,s)=>{t||(t=o(s).text().trim())}),o(`th:contains("${a}")`).next("td").each((e,s)=>{t||(t=o(s).text().trim())}),t}extractPartes(o){const a=[];return o("#tableTodasPartes tr, .partes tr").each((t,e)=>{const s=o(e),r=s.find("td:first-child, th:first-child").text().trim().toLowerCase(),n=s.find("td:nth-child(2), td:last-child");if(r&&n.length){const i=n.text().trim();if(i&&!i.includes("Advogado")){let c="outros";r.includes("autor")||r.includes("requerente")||r.includes("exequente")?c="autor":r.includes("réu")||r.includes("requerido")||r.includes("executado")?c="reu":r.includes("terceiro")&&(c="terceiro"),a.push({nome:i,tipo:c,documento:this.extractDocumentFromText(i)})}}}),a}extractAdvogados(o){const a=[];return o(".advogado, .lawyer").each((t,e)=>{const s=o(e).text().trim(),r=s.match(/OAB[\/\s]*([A-Z]{2})[\/\s]*(\d+)/i);if(r){const n=s.replace(/OAB[\/\s]*[A-Z]{2}[\/\s]*\d+/i,"").trim();a.push({nome:n,oab:r[2],uf:r[1],tipo:"parte_autora",ativo:!0})}}),o("#tableTodasPartes tr, .partes tr").each((t,e)=>{const r=o(e).text(),n=r.match(/Advogad[ao].*?OAB[\/\s]*([A-Z]{2})[\/\s]*(\d+)/i);if(n){const i=r.match(/Advogad[ao][:\s]*(.*?)(?:OAB|$)/i),c=i?i[1].trim():"Nome não identificado";a.push({nome:c,oab:n[2],uf:n[1],tipo:"parte_autora",ativo:!0})}}),a}extractMovimentacoes(o){const a=[];return o("#tabelaTodasMovimentacoes tr, .movimentacoes tr, .timeline .movimento").each((t,e)=>{const s=o(e);if(s.find("th").length>0)return;const r=s.find(".dataMovimentacao, td:first-child, .data"),n=s.find(".descricaoMovimentacao, td:last-child, .descricao");if(r.length&&n.length){const i=r.text().trim(),c=n.text().trim();if(i&&c){const l=i.match(/(\d{2}\/\d{2}\/\d{4})/);let u="";if(l){const[v,g,w]=l[1].split("/");u=`${w}-${g}-${v}`}const m=i.match(/(\d{2}:\d{2})/),x=m?`${u}T${m[1]}:00`:void 0;a.push({id:`tjsp-mov-${t}`,data:u,dataHora:x,titulo:this.extractTituloMovimentacao(c),descricao:c.trim(),oficial:!0})}}}),a.sort((t,e)=>new Date(e.data).getTime()-new Date(t.data).getTime())}extractTituloMovimentacao(o){let t=o.split(`
`)[0].trim();return t=t.replace(/^\d+\s*-\s*/,""),t.length>100&&(t=t.substring(0,100)+"..."),t||"Movimentação processual"}extractDocumentFromText(o){const a=o.match(/(\d{3}\.?\d{3}\.?\d{3}-?\d{2})/);if(a)return a[1];const t=o.match(/(\d{2}\.?\d{3}\.?\d{3}\/?\d{4}-?\d{2})/);if(t)return t[1]}async consultarMultiplosProcessos(o){const a=[];for(const t of o)try{const e=await this.consultarProcesso(t);a.push(e),await new Promise(s=>setTimeout(s,2e3))}catch(e){console.error(`Erro na consulta do processo ${t}:`,e)}return a}async verificarDisponibilidade(){try{const o=await this.client.makeRequest({method:"GET",url:"/cpopg/open.do",timeout:1e4});return o.status===200&&o.data.includes("Consulta de Processos")}catch{return!1}}async cleanup(){await this.client.cleanup()}}export{C as TJSPService};
