var m=Object.defineProperty;var h=(d,t,a)=>t in d?m(d,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):d[t]=a;var u=(d,t,a)=>h(d,typeof t!="symbol"?t+"":t,a);import{R as p,l}from"./realTribunalClient.service-CebukglM.js";import"./index-D82AO8B3.js";new Proxy({},{get(d,t){throw new Error(`Module "crypto" has been externalized for browser compatibility. Cannot access "crypto.${t}" in client code.  See https://vite.dev/guide/troubleshooting.html#module-externalized-for-browser-compatibility for more details.`)}});class w{constructor(){u(this,"client");this.client=new p({baseURL:"https://cav.receita.fazenda.gov.br",timeout:6e4,rateLimitDelay:5e3,retryAttempts:3,userAgent:"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",enableCookies:!0})}async consultarProcesso(t,a){try{const e=await this.client.makeRequest({method:"GET",url:"/aplicacoes/atidc/sicav/ConsultaPublicaProcessos/paginas/ConsultaPublica.aspx"}),o=l(e.data),n=o('input[name="__VIEWSTATE"]').val()||"",r=o('input[name="__VIEWSTATEGENERATOR"]').val()||"",s=o('input[name="__EVENTVALIDATION"]').val()||"",c=new URLSearchParams({__EVENTTARGET:"",__EVENTARGUMENT:"",__VIEWSTATE:n,__VIEWSTATEGENERATOR:r,__EVENTVALIDATION:s,ctl00$cphConteudo$txtNumeroProcesso:t,ctl00$cphConteudo$txtCpfCnpj:a,ctl00$cphConteudo$btnConsultar:"Consultar"}),i=await this.client.makeRequest({method:"POST",url:"/aplicacoes/atidc/sicav/ConsultaPublicaProcessos/paginas/ConsultaPublica.aspx",data:c,headers:{"Content-Type":"application/x-www-form-urlencoded",Referer:"https://cav.receita.fazenda.gov.br/aplicacoes/atidc/sicav/ConsultaPublicaProcessos/paginas/ConsultaPublica.aspx"}});return this.parseProcessCAV(i.data,t)}catch(e){throw new Error(`Erro na consulta Receita Federal: ${e instanceof Error?e.message:"Erro desconhecido"}`)}}async consultarCARP(t){try{const a=await this.client.makeRequest({method:"GET",url:`/aplicacoes/atidc/carf/consulta/consultaPublica.aspx?numProc=${t}`});return this.parseProcessCARP(a.data,t)}catch(a){throw new Error(`Erro na consulta CARF: ${a instanceof Error?a.message:"Erro desconhecido"}`)}}parseProcessCAV(t,a){const e=l(t);if(e(".erro, .mensagem-erro").length>0||e('span:contains("Não foram encontrados")').length>0)throw new Error("Processo não encontrado na Receita Federal");const o={numero:a,classe:"Processo Administrativo Fiscal",assunto:"",dataAjuizamento:"",situacao:"Em andamento",localizacao:"Receita Federal do Brasil",orgaoJulgador:"Receita Federal",partes:[],advogados:[],movimentacoes:[],audiencias:[],documentos:[],recursos:[]};return e("table.dados-processo tr, .info-processo tr").each((n,r)=>{const s=e(r),c=s.find("td:first-child, th:first-child").text().trim(),i=s.find("td:last-child").text().trim();switch(c.toLowerCase()){case"situação":case"status":o.situacao=i;break;case"assunto":case"matéria":o.assunto=i;break;case"data de abertura":case"data autuação":o.dataAjuizamento=this.parseDate(i);break;case"órgão":case"unidade":o.orgaoJulgador=i,o.localizacao=i;break;case"interessado":case"contribuinte":o.partes.push({nome:i,tipo:"autor",documento:this.extractDocumento(i)});break}}),o.movimentacoes=this.extractMovimentacoesCAV(e),o}parseProcessCARP(t,a){const e=l(t),o={numero:a,classe:"Recurso Administrativo",assunto:"",dataAjuizamento:"",situacao:"Em andamento",localizacao:"CARF",orgaoJulgador:"Conselho Administrativo de Recursos Fiscais",partes:[],advogados:[],movimentacoes:[],audiencias:[],documentos:[],recursos:[]};return e(".dados-processo, .info-recurso").find("tr").each((n,r)=>{const s=e(r),c=s.find("td:first-child").text().trim(),i=s.find("td:last-child").text().trim();c.toLowerCase().includes("situação")?o.situacao=i:c.toLowerCase().includes("assunto")?o.assunto=i:c.toLowerCase().includes("data")&&(o.dataAjuizamento=this.parseDate(i))}),o.movimentacoes=this.extractMovimentacoesCARP(e),o}extractMovimentacoesCAV(t){const a=[];return t(".movimentacoes table tr, .historico table tr").each((e,o)=>{const r=t(o).find("td");if(r.length>=3){const s=r.eq(0).text().trim(),c=r.eq(1).text().trim(),i=r.eq(2).text().trim();s&&c&&this.isValidDate(s)&&a.push({id:`rf-mov-${e}`,data:this.parseDate(s),titulo:this.extractTitulo(c),descricao:`${c} - Responsável: ${i}`,oficial:!0})}}),a.sort((e,o)=>new Date(o.data).getTime()-new Date(e.data).getTime())}extractMovimentacoesCARP(t){const a=[];return t(".timeline-carf .evento, .movimentacoes-carf tr").each((e,o)=>{const n=t(o),r=n.find(".data-evento, td:first-child").text().trim(),s=n.find(".descricao-evento, td:nth-child(2)").text().trim();r&&s&&this.isValidDate(r)&&a.push({id:`carf-mov-${e}`,data:this.parseDate(r),titulo:this.extractTitulo(s),descricao:s,oficial:!0})}),a}async consultarDividaAtiva(t){try{const a=await this.client.makeRequest({method:"GET",url:`/aplicacoes/atidc/certidao/CndConjuntaInter/paginas/ConsultaSituacao.aspx?CPF=${t}`}),e=l(a.data),o=[];return e(".debito-ativo").each((n,r)=>{const s=e(r);o.push({numeroInscricao:s.find(".numero-inscricao").text().trim(),valor:this.parseValor(s.find(".valor-debito").text().trim()),situacao:s.find(".situacao-debito").text().trim(),dataInscricao:this.parseDate(s.find(".data-inscricao").text().trim())})}),o}catch(a){throw new Error(`Erro na consulta de dívida ativa: ${a instanceof Error?a.message:"Erro desconhecido"}`)}}async consultarCertidoes(t){try{const a=this.generateConsultaHash(t),e=await this.client.makeRequest({method:"POST",url:"/aplicacoes/atidc/certidao/CndConjuntaInter/paginas/InformaNICertidao.aspx",data:new URLSearchParams({ni:t,hash:a})}),o=l(e.data);return{situacao:o(".situacao-certidao").text().trim(),validadeAte:this.parseDate(o(".validade-certidao").text().trim()),observacoes:o(".obs-certidao").text().trim()}}catch(a){throw new Error(`Erro na consulta de certidões: ${a instanceof Error?a.message:"Erro desconhecido"}`)}}parseDate(t){if(!t)return"";const a=t.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);if(a){const[,e,o,n]=a;return`${n}-${o.padStart(2,"0")}-${e.padStart(2,"0")}`}return""}parseValor(t){return t&&parseFloat(t.replace(/[^\d,]/g,"").replace(",","."))||0}isValidDate(t){return!!t.match(/\d{1,2}\/\d{1,2}\/\d{4}/)}extractTitulo(t){let e=t.split(`
`)[0].trim();return e.length>100&&(e=e.substring(0,100)+"..."),e||"Movimentação administrativa"}extractDocumento(t){const a=t.match(/\d{3}\.?\d{3}\.?\d{3}-?\d{2}/);if(a)return a[0];const e=t.match(/\d{2}\.?\d{3}\.?\d{3}\/?\d{4}-?\d{2}/);if(e)return e[0]}generateConsultaHash(t){const a=Date.now().toString();return(void 0)("md5").update(t+a).digest("hex").substring(0,16)}async verificarDisponibilidade(){try{return(await this.client.makeRequest({method:"GET",url:"/",timeout:1e4})).status===200}catch{return!1}}async cleanup(){await this.client.cleanup()}}export{w as ReceitaFederalService};
