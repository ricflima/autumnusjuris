var b=Object.defineProperty;var w=(n,e,t)=>e in n?b(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var u=(n,e,t)=>w(n,typeof e!="symbol"?e+"":e,t);import{R as l,l as g}from"./realTribunalClient.service-CebukglM.js";import"./index-D82AO8B3.js";const p=require("puppeteer-extra"),f=require("puppeteer-extra-plugin-stealth");p.use(f());class v{constructor(){u(this,"client");u(this,"rules",new Map);this.client=new l({baseURL:"",timeout:6e4,rateLimitDelay:2e3,retryAttempts:3,enableStealth:!0}),this.loadScrapingRules()}loadScrapingRules(){this.rules.set("tjmg",{tribunal:"tjmg",name:"TJMG - Tribunal de Justiça de MG",baseURL:"https://www4.tjmg.jus.br",searchPath:"/juridico/sf/proc_complemento/proc_consulta_publica.jsp",searchMethod:"POST",searchParams:{txtNum:"{numeroProcesso}",cmbGrau:"1",Submit:"Pesquisar"},selectors:{processNumber:".numero-processo, .proc-numero",className:".classe-processual",subject:".assunto-processo",distributionDate:".data-distribuicao",situation:".situacao-processo",location:".localizacao-processo",judge:".juiz-processo",parties:".parte-processo",lawyers:".advogado-processo",movements:".movimentacao-processual",movementDate:".data-movimentacao",movementDescription:".descricao-movimentacao",errorMessage:".mensagem-erro"},requiresCaptcha:!1,requiresCertificate:!1,rateLimit:3e3}),this.rules.set("tjrj",{tribunal:"tjrj",name:"TJRJ - Tribunal de Justiça do RJ",baseURL:"http://www4.tjrj.jus.br",searchPath:"/ConsultaPublica/",searchMethod:"POST",searchParams:{numeroProcesso:"{numeroProcesso}",tipoProcesso:"publica"},selectors:{processNumber:".numero-processo",className:".classe",subject:".assunto",distributionDate:".distribuicao",situation:".situacao",location:".vara",judge:".magistrado",parties:".partes tbody tr",lawyers:".advogado",movements:".movimentacoes tbody tr",movementDate:"td:first-child",movementDescription:"td:last-child",errorMessage:".alert-danger"},requiresCaptcha:!0,requiresCertificate:!1,rateLimit:4e3}),this.rules.set("tjrs",{tribunal:"tjrs",name:"TJRS - Tribunal de Justiça do RS",baseURL:"https://www1.tjrs.jus.br",searchPath:"/busca/?tb=proc",searchMethod:"GET",searchParams:{q:"{numeroProcesso}",partialfields:"tribunal:Tribunal%20de%20Justica%20do%20RS"},selectors:{processNumber:".numero-processo",className:".classe-processual",subject:".assunto-processo",distributionDate:".data-autuacao",situation:".situacao-atual",location:".orgao-julgador",judge:".magistrado",parties:".partes .parte",lawyers:".advogados .advogado",movements:".andamentos .andamento",movementDate:".data-andamento",movementDescription:".texto-andamento",errorMessage:".sem-resultados"},requiresCaptcha:!1,requiresCertificate:!1,rateLimit:2e3}),this.rules.set("tst",{tribunal:"tst",name:"TST - Tribunal Superior do Trabalho",baseURL:"https://consultaunificada.tst.jus.br",searchPath:"/consulta.do",searchMethod:"POST",searchParams:{"conscsjt.numeroTST":"{numeroProcesso}","conscsjt.digito":"","conscsjt.ano":"","conscsjt.orgao":"","conscsjt.tribunal":"","conscsjt.origem":"","conscsjt.tipoProcesso":"1","conscsjt.proximaIteracao":"false","conscsjt.ordemIteracao":"false"},selectors:{processNumber:".numero-unico",className:".classe-judicial",subject:".assunto-principal",distributionDate:".data-autuacao",situation:".situacao-processo",location:".orgao-julgador-atual",judge:".magistrado",parties:".partes-processo tbody tr",lawyers:".representantes tbody tr",movements:".movimentacoes tbody tr",movementDate:"td:nth-child(1)",movementDescription:"td:nth-child(2)",errorMessage:".aviso"},requiresCaptcha:!1,requiresCertificate:!1,rateLimit:3e3})}async scrapeProcess(e,t){const a=this.rules.get(e);if(!a)throw new Error(`Regras de scraping não encontradas para o tribunal: ${e}`);this.client=new l({baseURL:a.baseURL,timeout:6e4,rateLimitDelay:a.rateLimit,retryAttempts:3,enableStealth:!0,userAgent:a.userAgent||"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"});try{let s;return a.requiresCaptcha||a.requiresCertificate?s=await this.scrapeWithPuppeteer(a,t):s=await this.scrapeWithHTTP(a,t),this.parseProcessData(s,a,t)}catch(s){throw new Error(`Erro no scraping do ${e}: ${s instanceof Error?s.message:"Erro desconhecido"}`)}}async scrapeWithHTTP(e,t){if(e.searchMethod==="GET"){const a=new URLSearchParams;return Object.entries(e.searchParams).forEach(([o,r])=>{a.append(o,r.replace("{numeroProcesso}",t))}),(await this.client.makeRequest({method:"GET",url:`${e.searchPath}?${a.toString()}`})).data}else{const a=new URLSearchParams;return Object.entries(e.searchParams).forEach(([o,r])=>{a.append(o,r.replace("{numeroProcesso}",t))}),(await this.client.makeRequest({method:"POST",url:e.searchPath,data:a,headers:{"Content-Type":"application/x-www-form-urlencoded"}})).data}}async scrapeWithPuppeteer(e,t){const a=await p.launch({headless:!0,args:["--no-sandbox","--disable-setuid-sandbox","--disable-blink-features=AutomationControlled","--disable-features=VizDisplayCompositor"]});try{const s=await a.newPage();if(await s.setUserAgent(e.userAgent||"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"),await s.goto(`${e.baseURL}${e.searchPath}`,{waitUntil:"networkidle0",timeout:6e4}),e.searchMethod==="POST"){for(const[r,i]of Object.entries(e.searchParams)){const c=i.replace("{numeroProcesso}",t),h=[`input[name="${r}"]`,`input[id="${r}"]`,`select[name="${r}"]`,`textarea[name="${r}"]`];let m=!1;for(const d of h)try{await s.waitForSelector(d,{timeout:5e3}),await s.type(d,c),m=!0;break}catch{}m||console.warn(`Campo não encontrado: ${r}`)}e.requiresCaptcha&&await this.solveCaptcha(s),await Promise.all([s.waitForNavigation({waitUntil:"networkidle0",timeout:3e4}),s.click('input[type="submit"], button[type="submit"], .btn-submit')])}return await s.waitForTimeout(2e3),await s.content()}finally{await a.close()}}async solveCaptcha(e){try{await e.$('img[src*="captcha"], img[src*="verificacao"]')&&(console.log("CAPTCHA detectado - implementação de resolução necessária"),await e.waitForTimeout(5e3))}catch(t){console.warn("Erro ao processar CAPTCHA:",t)}}parseProcessData(e,t,a){const s=g(e);if(t.selectors.errorMessage&&s(t.selectors.errorMessage).length>0)throw new Error("Processo não encontrado ou erro na consulta");return{numero:a,classe:this.extractText(s,t.selectors.className),assunto:this.extractText(s,t.selectors.subject),dataAjuizamento:this.parseDate(this.extractText(s,t.selectors.distributionDate)),situacao:this.extractText(s,t.selectors.situation)||"Em andamento",localizacao:this.extractText(s,t.selectors.location),orgaoJulgador:this.extractText(s,t.selectors.judge)||t.name,partes:this.extractParties(s,t.selectors.parties),advogados:this.extractLawyers(s,t.selectors.lawyers),movimentacoes:this.extractMovements(s,t),audiencias:[],documentos:[],recursos:[]}}extractText(e,t){return e(t).first().text().trim()}extractParties(e,t){const a=[];return e(t).each((s,o)=>{const r=e(o).text().trim();r&&a.push({nome:r,tipo:"outros",documento:this.extractDocumentFromText(r)})}),a}extractLawyers(e,t){const a=[];return e(t).each((s,o)=>{const r=e(o).text().trim(),i=r.match(/OAB[\\/\s]*([A-Z]{2})[\\/\s]*(\d+)/i);if(i){const c=r.replace(/OAB[\\/\s]*[A-Z]{2}[\\/\s]*\d+/i,"").trim();a.push({nome:c,oab:i[2],uf:i[1],tipo:"parte_autora",ativo:!0})}}),a}extractMovements(e,t){const a=[];return e(t.selectors.movements).each((s,o)=>{const r=e(o),i=r.find(t.selectors.movementDate).text().trim(),c=r.find(t.selectors.movementDescription).text().trim();i&&c&&a.push({id:`${t.tribunal}-mov-${s}`,data:this.parseDate(i),titulo:this.extractTitle(c),descricao:c,oficial:!0})}),a.sort((s,o)=>new Date(o.data).getTime()-new Date(s.data).getTime())}parseDate(e){if(!e)return"";const t=e.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})/);if(t){const[,a,s,o]=t;return`${o}-${s.padStart(2,"0")}-${a.padStart(2,"0")}`}return""}extractTitle(e){let a=e.split(`
`)[0].trim();return a.length>100&&(a=a.substring(0,100)+"..."),a||"Movimentação processual"}extractDocumentFromText(e){const t=e.match(/(\d{3}\.?\d{3}\.?\d{3}-?\d{2})/);if(t)return t[1];const a=e.match(/(\d{2}\.?\d{3}\.?\d{3}\/?\d{4}-?\d{2})/);if(a)return a[1]}addScrapingRule(e){this.rules.set(e.tribunal,e)}getSupportedTribunals(){return Array.from(this.rules.keys())}isSupported(e){return this.rules.has(e)}async testTribunal(e){const t=this.rules.get(e);if(!t)return!1;try{const a=new l({baseURL:t.baseURL,timeout:1e4}),s=await a.makeRequest({method:"GET",url:"/"});return await a.cleanup(),s.status===200}catch{return!1}}async cleanup(){await this.client.cleanup()}}export{v as TribunalScraper};
